<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Arch Guide â€“ Neighborhood Map</title>

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #map { 
      width: 100%; 
      height: 100%; 
    }
    
    /* Custom Info Window Styling */
    .building-info {
      max-width: 250px;
      cursor: pointer;
    }
    .building-info img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .building-info h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #000;
    }
    .building-info p {
      margin: 0;
      font-size: 13px;
      color: #666;
    }
    
    /* Neighborhood Label Styling */
    .neighborhood-label {
      background: rgba(255,255,255,0.95);
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      color: #222;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      white-space: nowrap;
      border: 2px solid white;
    }
    .neighborhood-label:hover {
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --- Configuration ---
    const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zdXptcmZ6emtxZmZocGlsaXJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjY5NDAsImV4cCI6MjA4MjM0Mjk0MH0.kGHLaDT2FR9AAnZjP96FgAcSPjCQm6w9ifAqd6cEOoQ';
    const GOOGLE_API_KEY = 'AIzaSyA7V2NGf1mZmSb-2VB5DqZoL43ApTRhwYs';
    
    // --- Neighborhood Data ---
    const NEIGHBORHOODS = [
      { id: "DTL", name: "Downtown LA", center: { lat: 34.0407, lng: -118.2468 }, radius: 1800, color: "#1150AB" },
      { id: "SLV", name: "Silver Lake", center: { lat: 34.0864, lng: -118.2709 }, radius: 1400, color: "#2E7D6F" },
      { id: "PAS", name: "Pasadena", center: { lat: 34.1478, lng: -118.1445 }, radius: 1600, color: "#C56B3C" }
    ];

    let map;
    let circles = [];
    let markers = [];
    let labels = [];
    let buildingMarkers = [];
    let infoWindow;

    // --- Initialize Map ---
    function initMap() {
      // Create map with Apple Maps-like styling
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 34.0522, lng: -118.2437 },
        zoom: 10,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        styles: [
          {
            "featureType": "all",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#000000" }]
          },
          {
            "featureType": "all",
            "elementType": "labels.text.stroke",
            "stylers": [{ "color": "#ffffff" }, { "weight": 2 }]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{ "color": "#ffffff" }]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{ "color": "#a2d4ec" }]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [{ "color": "#f5f5f5" }]
          },
          {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [{ "color": "#e8ebe8" }]
          }
        ]
      });

      infoWindow = new google.maps.InfoWindow();

      // Draw neighborhoods
      drawNeighborhoods();
    }

    // --- Draw Neighborhood Circles ---
    function drawNeighborhoods() {
      NEIGHBORHOODS.forEach(neighborhood => {
        // Create circle
        const circle = new google.maps.Circle({
          map: map,
          center: neighborhood.center,
          radius: neighborhood.radius,
          fillColor: neighborhood.color,
          fillOpacity: 0.12,
          strokeColor: neighborhood.color,
          strokeOpacity: 0.6,
          strokeWeight: 2.5,
          clickable: true
        });

        // Click handler for circle
        circle.addListener('click', () => {
          zoomToNeighborhood(neighborhood);
        });

        circles.push(circle);

        // Create custom label overlay
        const labelOverlay = new google.maps.OverlayView();
        
        labelOverlay.onAdd = function() {
          const div = document.createElement('div');
          div.className = 'neighborhood-label';
          div.textContent = neighborhood.name;
          div.style.borderColor = neighborhood.color;
          
          div.addEventListener('click', () => {
            zoomToNeighborhood(neighborhood);
          });

          const panes = this.getPanes();
          panes.overlayMouseTarget.appendChild(div);
          this.div = div;
        };

        labelOverlay.draw = function() {
          const projection = this.getProjection();
          const position = projection.fromLatLngToDivPixel(
            new google.maps.LatLng(neighborhood.center.lat, neighborhood.center.lng)
          );
          
          if (this.div) {
            this.div.style.left = position.x - (this.div.offsetWidth / 2) + 'px';
            this.div.style.top = position.y - (this.div.offsetHeight / 2) + 'px';
            this.div.style.position = 'absolute';
          }
        };

        labelOverlay.onRemove = function() {
          if (this.div) {
            this.div.parentNode.removeChild(this.div);
            this.div = null;
          }
        };

        labelOverlay.setMap(map);
        labels.push(labelOverlay);
      });
    }

    // --- Zoom to Neighborhood ---
    async function zoomToNeighborhood(neighborhood) {
      // Zoom in
      map.panTo(neighborhood.center);
      map.setZoom(14);

      // Load and show buildings
      await loadBuildings(neighborhood);
    }

    // --- Load Buildings from Supabase ---
    async function loadBuildings(neighborhood) {
      // Clear existing building markers
      buildingMarkers.forEach(marker => marker.setMap(null));
      buildingMarkers = [];

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/buildings?neighborhood_id=eq.${neighborhood.id}&select=id,title,latitude,longitude,image`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const buildings = await response.json();
        console.log(`Loaded ${buildings.length} buildings for ${neighborhood.name}`);

        // Add building markers
        buildings.forEach(building => {
          if (!building.latitude || !building.longitude) return;

          const marker = new google.maps.Marker({
            map: map,
            position: { lat: building.latitude, lng: building.longitude },
            title: building.title,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: neighborhood.color,
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });

          // Click handler for marker
          marker.addListener('click', () => {
            showBuildingPopup(building, marker);
          });

          buildingMarkers.push(marker);
        });

      } catch (error) {
        console.error('Error loading buildings:', error);
      }
    }

    // --- Show Building Popup ---
    function showBuildingPopup(building, marker) {
      const content = `
        <div class="building-info" onclick="navigateToBuilding('${building.id}', '${building.title.replace(/'/g, "\\'")}')">
          ${building.image ? `<img src="${building.image}" alt="${building.title}" />` : ''}
          <h3>${building.title}</h3>
          <p>Tap to view details</p>
        </div>
      `;

      infoWindow.setContent(content);
      infoWindow.open(map, marker);
    }

    // --- Navigate to Building (send to Draftbit) ---
    function navigateToBuilding(buildingId, buildingTitle) {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          action: 'navigateToBuilding',
          buildingId: buildingId,
          buildingTitle: buildingTitle
        }));
      } else {
        console.log('Navigate to building:', buildingId, buildingTitle);
      }
    }

    // --- Load Google Maps Script ---
    function loadGoogleMapsScript() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    // Start loading
    loadGoogleMapsScript();
  </script>
</body>
</html>
